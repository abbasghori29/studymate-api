name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.LIGHTSAIL_SSH_KEY }}" ] && MISSING="$MISSING LIGHTSAIL_SSH_KEY"
          [ -z "${{ secrets.LIGHTSAIL_HOST }}" ] && MISSING="$MISSING LIGHTSAIL_HOST"
          [ -z "${{ secrets.OPENAI_API_KEY }}" ] && MISSING="$MISSING OPENAI_API_KEY"
          [ -z "${{ secrets.PINECONE_API_KEY }}" ] && MISSING="$MISSING PINECONE_API_KEY"
          [ -z "${{ secrets.SECRET_KEY }}" ] && MISSING="$MISSING SECRET_KEY"
          if [ -n "$MISSING" ]; then
            echo "‚ùå Missing required secrets:$MISSING"
            exit 1
          fi
          echo "‚úÖ All required secrets are set"
          echo "üìç Target: ec2-user@${{ secrets.LIGHTSAIL_HOST }}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create .env file
        run: |
          cat > /tmp/app.env << 'STATIC_PART'
          PROJECT_NAME=StudyMate API
          VERSION=0.1.0
          DEBUG=False
          HOST=0.0.0.0
          PORT=8005
          DATABASE_URL=sqlite:///./app.db
          DB_ECHO=False
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          VECTOR_STORE_PATH=faiss_index_openai
          PINECONE_INDEX_NAME=cafs-chatbot-memory
          PINECONE_CLOUD=aws
          PINECONE_REGION=us-east-1
          BACKEND_CORS_ORIGINS=["https://growize.co","http://localhost:3000","http://localhost:8005"]
          STATIC_PART
          sed -i 's/^          //' /tmp/app.env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> /tmp/app.env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> /tmp/app.env
          echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> /tmp/app.env

      - name: Create Nginx config
        run: |
          cat > /tmp/nginx.conf << 'NGINX_CONF'
          server {
              listen 80;
              server_name growize.co;
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
              location / {
                  return 301 https://$host$request_uri;
              }
          }
          NGINX_CONF
          sed -i 's/^          //' /tmp/nginx.conf

      - name: Create Nginx SSL config
        run: |
          cat > /tmp/nginx-ssl.conf << 'NGINX_SSL'
          server {
              listen 80;
              server_name growize.co;
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
              location / {
                  return 301 https://$host$request_uri;
              }
          }
          server {
              listen 443 ssl http2;
              server_name growize.co;
              ssl_certificate /etc/letsencrypt/live/growize.co/fullchain.pem;
              ssl_certificate_key /etc/letsencrypt/live/growize.co/privkey.pem;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;
              ssl_session_cache shared:SSL:10m;
              ssl_session_timeout 10m;
              add_header Strict-Transport-Security "max-age=31536000" always;
              add_header X-Content-Type-Options "nosniff" always;
              client_max_body_size 10M;
              location / {
                  proxy_pass http://127.0.0.1:8005;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-Port $server_port;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }
          }
          NGINX_SSL
          sed -i 's/^          //' /tmp/nginx-ssl.conf

      - name: Upload configs to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/app.env /tmp/nginx.conf /tmp/nginx-ssl.conf \
            ec2-user@${{ secrets.LIGHTSAIL_HOST }}:/tmp/

      - name: Deploy to Lightsail
        env:
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
          REPO_URL: ${{ github.event.repository.clone_url }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            ec2-user@$HOST \
            "export APP_DIR='/home/ec2-user/studymate-api' && \
             export REPO_URL='$REPO_URL' && \
             bash" << 'DEPLOY_SCRIPT'
          set -e

          echo "üöÄ Starting studymate-api deployment..."

          # ‚îÄ‚îÄ 1. Install system prerequisites (Amazon Linux 2023) ‚îÄ‚îÄ
          echo "üì¶ Installing system prerequisites..."
          if command -v dnf &> /dev/null; then
            PKG_MGR="dnf"
          else
            PKG_MGR="yum"
          fi
          sudo $PKG_MGR update -y
          sudo $PKG_MGR install -y git python3.11 python3.11-pip python3.11-devel \
            gcc gcc-c++ make cmake nginx openssl

          # ‚îÄ‚îÄ 2. Setup swap file (safety net for 2GB RAM) ‚îÄ‚îÄ
          if [ ! -f /swapfile ]; then
            echo "üíæ Creating 1GB swap file..."
            sudo fallocate -l 1G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            echo "‚úÖ Swap file created and enabled"
          else
            echo "‚úÖ Swap file already exists"
          fi

          # ‚îÄ‚îÄ 3. Find Python ‚îÄ‚îÄ
          if command -v python3.11 &> /dev/null; then
            PYTHON_CMD=python3.11
          elif command -v python3 &> /dev/null; then
            PYTHON_CMD=python3
          else
            echo "‚ùå Python not found!"
            exit 1
          fi
          echo "‚úÖ Python: $PYTHON_CMD ($($PYTHON_CMD --version))"

          # ‚îÄ‚îÄ 4. Clone or pull repository ‚îÄ‚îÄ
          if [ ! -d "$APP_DIR" ]; then
            echo "üìÅ Creating application directory: $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            echo "üì• Cloning repository (first-time setup)..."
            git clone "$REPO_URL" .
          else
            cd "$APP_DIR"
            echo "üîÑ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
          fi

          # ‚îÄ‚îÄ 5. Move .env file from upload ‚îÄ‚îÄ
          echo "üìù Setting up .env file..."
          cp /tmp/app.env .env
          chmod 600 .env
          echo "‚úÖ .env file created"

          # ‚îÄ‚îÄ 6. Setup virtual environment & install dependencies ‚îÄ‚îÄ
          if [ ! -d "venv" ]; then
            echo "üêç Creating virtual environment..."
            $PYTHON_CMD -m venv venv
          fi
          source venv/bin/activate
          echo "üì• Installing dependencies..."
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

          # ‚îÄ‚îÄ 7. Check vector store ‚îÄ‚îÄ
          if [ -d "faiss_index_openai" ]; then
            echo "‚úÖ Vector store found"
            ls -la faiss_index_openai/ | head -5
          else
            echo "‚ö†Ô∏è  Vector store (faiss_index_openai) not found!"
            echo "   Upload it manually or run the training script on the server."
          fi

          # ‚îÄ‚îÄ 8. Setup systemd service ‚îÄ‚îÄ
          echo "‚öôÔ∏è  Configuring systemd service..."
          sudo cp studymate-api.service /etc/systemd/system/studymate-api.service
          sudo systemctl daemon-reload
          sudo systemctl enable studymate-api

          # ‚îÄ‚îÄ 9. Setup Nginx + Let's Encrypt SSL ‚îÄ‚îÄ
          echo "üîí Configuring Nginx with Let's Encrypt SSL..."
          sudo mkdir -p /var/www/certbot
          sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
          sudo rm -f /etc/nginx/conf.d/studymate-api.conf 2>/dev/null || true

          # Install certbot
          sudo $PKG_MGR install -y certbot python3-certbot-nginx 2>/dev/null || \
            sudo pip3 install certbot certbot-nginx 2>/dev/null || true

          if [ -f /etc/letsencrypt/live/growize.co/fullchain.pem ]; then
            echo "‚úÖ Let's Encrypt certificate already exists"
            sudo cp /tmp/nginx-ssl.conf /etc/nginx/conf.d/studymate-api.conf
            sudo nginx -t && sudo systemctl restart nginx
            echo "üîÑ Attempting certificate renewal..."
            sudo certbot renew --quiet || true
          else
            echo "üîê Getting Let's Encrypt certificate for growize.co..."
            sudo cp /tmp/nginx.conf /etc/nginx/conf.d/studymate-api.conf
            sudo nginx -t && sudo systemctl restart nginx
            sudo certbot certonly --webroot -w /var/www/certbot \
              -d growize.co \
              --non-interactive --agree-tos \
              --email admin@growize.co \
              --no-eff-email || {
              echo "‚ö†Ô∏è  Webroot method failed, trying nginx plugin..."
              sudo certbot --nginx -d growize.co \
                --non-interactive --agree-tos \
                --email admin@growize.co \
                --no-eff-email || echo "‚ùå Let's Encrypt failed. Check DNS and firewall."
            }
            if [ -f /etc/letsencrypt/live/growize.co/fullchain.pem ]; then
              sudo cp /tmp/nginx-ssl.conf /etc/nginx/conf.d/studymate-api.conf
              sudo nginx -t && sudo systemctl restart nginx
              echo "‚úÖ Let's Encrypt certificate installed!"
            fi
          fi

          sudo systemctl enable nginx

          # Certbot auto-renewal (systemd timer is set up by certbot automatically)
          sudo systemctl enable certbot-renew.timer 2>/dev/null || true
          sudo systemctl start certbot-renew.timer 2>/dev/null || true

          # ‚îÄ‚îÄ 10. Stop old lms-bot service if it exists ‚îÄ‚îÄ
          sudo systemctl stop lms-bot 2>/dev/null || true
          sudo systemctl disable lms-bot 2>/dev/null || true
          sudo rm -f /etc/systemd/system/lms-bot.service 2>/dev/null || true

          # ‚îÄ‚îÄ 11. Restart application ‚îÄ‚îÄ
          echo "üîÑ Restarting application..."
          sudo systemctl daemon-reload
          sudo systemctl restart studymate-api

          # ‚îÄ‚îÄ 12. Cleanup temp files ‚îÄ‚îÄ
          rm -f /tmp/app.env /tmp/nginx.conf /tmp/nginx-ssl.conf

          # ‚îÄ‚îÄ 13. Deployment summary ‚îÄ‚îÄ
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ DEPLOYMENT COMPLETED ‚Äî studymate-api"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "üìä Service status:"
          sudo systemctl status studymate-api --no-pager -l || echo "‚ö†Ô∏è  Status unavailable"
          echo ""
          echo "üìã Recent logs:"
          sudo journalctl -u studymate-api -n 20 --no-pager || true
          echo ""
          echo "üîç Port check:"
          sudo ss -tulpn | grep -E '8005|443|80' || echo "‚ö†Ô∏è  Ports not listening yet"
          echo ""
          echo "üîë .env check:"
          if grep -q "OPENAI_API_KEY=" .env && ! grep -q "OPENAI_API_KEY=$" .env; then
            echo "  ‚úÖ OPENAI_API_KEY is set"
          else
            echo "  ‚ùå OPENAI_API_KEY missing"
          fi
          if grep -q "PINECONE_API_KEY=" .env && ! grep -q "PINECONE_API_KEY=$" .env; then
            echo "  ‚úÖ PINECONE_API_KEY is set"
          else
            echo "  ‚ùå PINECONE_API_KEY missing"
          fi
          echo ""
          echo "üîí SSL check:"
          if [ -f /etc/letsencrypt/live/growize.co/fullchain.pem ]; then
            echo "  ‚úÖ Let's Encrypt certificate active"
            sudo openssl x509 -in /etc/letsencrypt/live/growize.co/fullchain.pem -noout -dates 2>/dev/null || true
          else
            echo "  ‚ùå Let's Encrypt certificate not found"
          fi
          echo ""
          echo "üåê Application URLs:"
          echo "   https://growize.co"
          echo "   https://growize.co/api/v1/widget/embed"
          echo "   https://growize.co/docs"
          echo ""
          DEPLOY_SCRIPT

      - name: Health Check
        continue-on-error: true
        timeout-minutes: 2
        run: |
          echo "‚è≥ Waiting 20s for application to start..."
          sleep 20
          echo "üè• Running health checks..."
          echo ""
          echo "‚Üí HTTPS check (domain):"
          curl -s --max-time 10 --connect-timeout 5 \
            https://growize.co/health \
            && echo " ‚úÖ https://growize.co OK" \
            || echo " ‚ö†Ô∏è  HTTPS failed"
          echo ""
          echo "‚Üí HTTP check (direct IP):"
          curl -s --max-time 10 --connect-timeout 5 \
            http://${{ secrets.LIGHTSAIL_HOST }}:8005/health \
            && echo " ‚úÖ HTTP OK" \
            || echo " ‚ö†Ô∏è  HTTP failed"
