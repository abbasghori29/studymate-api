name: Deploy to Lightsail

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          MISSING=""
          [ -z "${{ secrets.LIGHTSAIL_SSH_KEY }}" ] && MISSING="$MISSING LIGHTSAIL_SSH_KEY"
          [ -z "${{ secrets.LIGHTSAIL_HOST }}" ] && MISSING="$MISSING LIGHTSAIL_HOST"
          [ -z "${{ secrets.OPENAI_API_KEY }}" ] && MISSING="$MISSING OPENAI_API_KEY"
          [ -z "${{ secrets.PINECONE_API_KEY }}" ] && MISSING="$MISSING PINECONE_API_KEY"
          [ -z "${{ secrets.SECRET_KEY }}" ] && MISSING="$MISSING SECRET_KEY"
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing required secrets:$MISSING"
            exit 1
          fi
          echo "âœ… All required secrets are set"
          echo "ğŸ“ Target: ec2-user@${{ secrets.LIGHTSAIL_HOST }}"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create .env file
        run: |
          cat > /tmp/app.env << 'STATIC_PART'
          PROJECT_NAME=StudyMate API
          VERSION=0.1.0
          DEBUG=False
          HOST=0.0.0.0
          PORT=8005
          DATABASE_URL=sqlite:///./app.db
          DB_ECHO=False
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          LOG_LEVEL=INFO
          LOG_FORMAT=json
          VECTOR_STORE_PATH=faiss_index_openai
          PINECONE_INDEX_NAME=cafs-chatbot-memory
          PINECONE_CLOUD=aws
          PINECONE_REGION=us-east-1
          STATIC_PART
          sed -i 's/^          //' /tmp/app.env
          echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> /tmp/app.env
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> /tmp/app.env
          echo "PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}" >> /tmp/app.env

      - name: Create Nginx config
        run: |
          cat > /tmp/nginx.conf << 'NGINX_CONF'
          server {
              listen 80;
              server_name _;
              return 301 https://$host$request_uri;
          }
          server {
              listen 443 ssl http2;
              server_name _;
              ssl_certificate /etc/nginx/ssl/studymate-api.crt;
              ssl_certificate_key /etc/nginx/ssl/studymate-api.key;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_ciphers HIGH:!aNULL:!MD5;
              ssl_prefer_server_ciphers on;
              ssl_session_cache shared:SSL:10m;
              ssl_session_timeout 10m;
              add_header Strict-Transport-Security "max-age=31536000" always;
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              client_max_body_size 10M;
              location / {
                  proxy_pass http://127.0.0.1:8005;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
                  proxy_set_header X-Forwarded-Host $host;
                  proxy_set_header X-Forwarded-Port $server_port;
                  proxy_connect_timeout 60s;
                  proxy_send_timeout 60s;
                  proxy_read_timeout 60s;
              }
          }
          NGINX_CONF
          sed -i 's/^          //' /tmp/nginx.conf

      - name: Upload configs to server
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/app.env /tmp/nginx.conf \
            ec2-user@${{ secrets.LIGHTSAIL_HOST }}:/tmp/

      - name: Deploy to Lightsail
        env:
          HOST: ${{ secrets.LIGHTSAIL_HOST }}
          REPO_URL: ${{ github.event.repository.clone_url }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
            ec2-user@$HOST \
            "export APP_DIR='/home/ec2-user/studymate-api' && \
             export REPO_URL='$REPO_URL' && \
             bash" << 'DEPLOY_SCRIPT'
          set -e

          echo "ğŸš€ Starting studymate-api deployment..."

          # â”€â”€ 1. Install system prerequisites (Amazon Linux 2023) â”€â”€
          echo "ğŸ“¦ Installing system prerequisites..."
          if command -v dnf &> /dev/null; then
            PKG_MGR="dnf"
          else
            PKG_MGR="yum"
          fi
          sudo $PKG_MGR update -y
          sudo $PKG_MGR install -y git python3.11 python3.11-pip python3.11-devel \
            gcc gcc-c++ make cmake nginx openssl

          # â”€â”€ 2. Setup swap file (safety net for 2GB RAM) â”€â”€
          if [ ! -f /swapfile ]; then
            echo "ğŸ’¾ Creating 1GB swap file..."
            sudo fallocate -l 1G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
            echo "âœ… Swap file created and enabled"
          else
            echo "âœ… Swap file already exists"
          fi

          # â”€â”€ 3. Find Python â”€â”€
          if command -v python3.11 &> /dev/null; then
            PYTHON_CMD=python3.11
          elif command -v python3 &> /dev/null; then
            PYTHON_CMD=python3
          else
            echo "âŒ Python not found!"
            exit 1
          fi
          echo "âœ… Python: $PYTHON_CMD ($($PYTHON_CMD --version))"

          # â”€â”€ 4. Clone or pull repository â”€â”€
          if [ ! -d "$APP_DIR" ]; then
            echo "ğŸ“ Creating application directory: $APP_DIR"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"
            echo "ğŸ“¥ Cloning repository (first-time setup)..."
            git clone "$REPO_URL" .
          else
            cd "$APP_DIR"
            echo "ğŸ”„ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
          fi

          # â”€â”€ 5. Move .env file from upload â”€â”€
          echo "ğŸ“ Setting up .env file..."
          SERVER_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo 'localhost')
          cp /tmp/app.env .env
          echo "BACKEND_CORS_ORIGINS=[\"https://$SERVER_IP\",\"http://$SERVER_IP:8005\",\"http://localhost:3000\",\"http://localhost:8005\"]" >> .env
          chmod 600 .env
          echo "âœ… .env file created"

          # â”€â”€ 6. Setup virtual environment & install dependencies â”€â”€
          if [ ! -d "venv" ]; then
            echo "ğŸ Creating virtual environment..."
            $PYTHON_CMD -m venv venv
          fi
          source venv/bin/activate
          echo "ğŸ“¥ Installing dependencies..."
          pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt

          # â”€â”€ 7. Check vector store â”€â”€
          if [ -d "faiss_index_openai" ]; then
            echo "âœ… Vector store found"
            ls -la faiss_index_openai/ | head -5
          else
            echo "âš ï¸  Vector store (faiss_index_openai) not found!"
            echo "   Upload it manually or run the training script on the server."
          fi

          # â”€â”€ 8. Setup systemd service â”€â”€
          echo "âš™ï¸  Configuring systemd service..."
          sudo cp studymate-api.service /etc/systemd/system/studymate-api.service
          sudo systemctl daemon-reload
          sudo systemctl enable studymate-api

          # â”€â”€ 9. Setup Nginx reverse proxy with SSL â”€â”€
          echo "ğŸ”’ Configuring Nginx with SSL..."
          sudo mkdir -p /etc/nginx/ssl
          if [ ! -f /etc/nginx/ssl/studymate-api.crt ]; then
            echo "ğŸ” Generating self-signed SSL certificate..."
            sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout /etc/nginx/ssl/studymate-api.key \
              -out /etc/nginx/ssl/studymate-api.crt \
              -subj "/C=US/ST=Ohio/L=Columbus/O=StudyMate/CN=$SERVER_IP" 2>/dev/null
            sudo chmod 600 /etc/nginx/ssl/studymate-api.key
            sudo chmod 644 /etc/nginx/ssl/studymate-api.crt
            echo "âœ… SSL certificate generated"
          else
            echo "âœ… SSL certificate already exists"
          fi

          sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
          sudo cp /tmp/nginx.conf /etc/nginx/conf.d/studymate-api.conf
          sudo nginx -t || echo "âš ï¸  Nginx config test failed"
          sudo systemctl enable nginx
          sudo systemctl restart nginx || echo "âš ï¸  Nginx restart failed"

          # â”€â”€ 10. Stop old lms-bot service if it exists â”€â”€
          sudo systemctl stop lms-bot 2>/dev/null || true
          sudo systemctl disable lms-bot 2>/dev/null || true
          sudo rm -f /etc/systemd/system/lms-bot.service 2>/dev/null || true

          # â”€â”€ 11. Restart application â”€â”€
          echo "ğŸ”„ Restarting application..."
          sudo systemctl daemon-reload
          sudo systemctl restart studymate-api

          # â”€â”€ 12. Cleanup temp files â”€â”€
          rm -f /tmp/app.env /tmp/nginx.conf

          # â”€â”€ 13. Deployment summary â”€â”€
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT COMPLETED â€” studymate-api"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Service status:"
          sudo systemctl status studymate-api --no-pager -l || echo "âš ï¸  Status unavailable"
          echo ""
          echo "ğŸ“‹ Recent logs:"
          sudo journalctl -u studymate-api -n 20 --no-pager || true
          echo ""
          echo "ğŸ” Port check:"
          sudo ss -tulpn | grep -E '8005|443|80' || echo "âš ï¸  Ports not listening yet"
          echo ""
          echo "ğŸ”‘ .env check:"
          if grep -q "OPENAI_API_KEY=" .env && ! grep -q "OPENAI_API_KEY=$" .env; then
            echo "  âœ… OPENAI_API_KEY is set"
          else
            echo "  âŒ OPENAI_API_KEY missing"
          fi
          if grep -q "PINECONE_API_KEY=" .env && ! grep -q "PINECONE_API_KEY=$" .env; then
            echo "  âœ… PINECONE_API_KEY is set"
          else
            echo "  âŒ PINECONE_API_KEY missing"
          fi
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "   HTTPS: https://$SERVER_IP"
          echo "   HTTP:  http://$SERVER_IP:8005"
          echo ""
          echo "âš ï¸  IMPORTANT: Open these ports in Lightsail Networking tab:"
          echo "   â†’ IPv4 Firewall: Add HTTPS (443) and HTTP (80)"
          echo ""
          DEPLOY_SCRIPT

      - name: Health Check
        continue-on-error: true
        timeout-minutes: 2
        run: |
          echo "â³ Waiting 20s for application to start..."
          sleep 20
          echo "ğŸ¥ Running health checks..."
          echo ""
          echo "â†’ HTTPS check:"
          curl -k --max-time 10 --connect-timeout 5 \
            https://${{ secrets.LIGHTSAIL_HOST }}/health \
            && echo " âœ… HTTPS OK" \
            || echo " âš ï¸  HTTPS failed"
          echo ""
          echo "â†’ HTTP check:"
          curl --max-time 10 --connect-timeout 5 \
            http://${{ secrets.LIGHTSAIL_HOST }}:8005/health \
            && echo " âœ… HTTP OK" \
            || echo " âš ï¸  HTTP failed (check Lightsail firewall)"
